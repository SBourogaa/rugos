---
- name: Configure kubectl on control node
  hosts: rugctl
  become: true
  vars_prompt:
    - name: "ansible_become_pass"
      prompt: "Enter sudo password"
      private: yes
  tasks:
    - name: Create .kube directory
      file:
        path: "/home/loqotia/.kube"
        state: directory
        mode: '0755'
        owner: loqotia
        group: loqotia

    - name: Get kubeconfig from K3s container
      shell: docker exec k3s-server cat /etc/rancher/k3s/k3s.yaml
      register: kubeconfig
      changed_when: false

    - name: Save kubeconfig
      copy:
        content: "{{ kubeconfig.stdout | replace('127.0.0.1', '10.42.0.1') }}"
        dest: "/home/loqotia/.kube/config"
        mode: '0600'
        owner: loqotia
        group: loqotia